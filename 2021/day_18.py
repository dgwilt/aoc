#!/usr/bin/env python3 
from sys import argv
from aoc import AocDay
from json import loads
from itertools import permutations
from functools import reduce

class AocDay18(AocDay):

    to_lines = lambda data: [[int(c) if c.isdigit() else c for c in line] for line in data.splitlines()]
    to_list = lambda num: loads("".join(str(c) for c in num))
    add_and_reduce = lambda a, b: AocDay18.reduce(AocDay18.add(a,b))

    def add(a,b):
        return ["["] + a + [","] + b +["]"]

    def explode(n):
        open = 0
        for i,c in enumerate(n):
            if open == 5:
                for rsearch in range(i+3,len(n)):
                    if isinstance(n[rsearch],int):
                        n[rsearch] += n[i+2]
                        break
                
                for lsearch in range(i-2,-1,-1):
                    if isinstance(n[lsearch],int):
                        n[lsearch] += n[i]
                        break

                return n[:i-1] + [0] + n[i+4:], True

            if c == "[": open += 1
            elif c == "]": open -= 1

        return n, False

    def split(n):
        for i in range(len(n)):
            if isinstance(d := n[i],int) and d > 9:
                half = d//2
                return n[:i] + AocDay18.add([half],[d-half]) + n[i+1:], True
        return n, False

    def magnitude(n):
        v0, v1 = [n[i] if isinstance(n[i],int) else AocDay18.magnitude(n[i]) for i in range(2)]
        return 3*v0 + 2*v1

    def reduce(n):
        # I very much did not like today's challenge :-(
        while True:
            while True:
                n, any_explosion = AocDay18.explode(n)
                if not any_explosion: break
            n, any_split = AocDay18.split(n)
            if not any_split: return n

    def run_silver(self,data):
        lines = AocDay18.to_lines(data)
        return AocDay18.magnitude(AocDay18.to_list(reduce(AocDay18.add_and_reduce,lines)))

    def run_gold(self,data):
        lines = AocDay18.to_lines(data)
        return max(AocDay18.magnitude(AocDay18.to_list(AocDay18.add_and_reduce(a,b))) for a,b in permutations(lines,2))

if __name__ == "__main__":

    data = """[[[[8,6],[0,8]],[5,2]],4]
[[[9,[7,7]],[6,2]],[[[5,9],5],[[7,1],6]]]
[[[7,[6,6]],[[8,5],8]],[[[2,9],[1,6]],[0,6]]]
[[[5,[7,5]],[9,2]],[[[2,4],[8,1]],[7,1]]]
[[[[9,1],[4,1]],[[5,9],[2,0]]],[5,[8,[0,3]]]]
[[[9,5],[9,[1,7]]],[[[9,9],[8,9]],4]]
[2,[[2,4],7]]
[[[[8,7],[9,5]],0],[[[6,7],[9,2]],7]]
[[[[5,5],3],[4,[2,3]]],[7,[7,7]]]
[8,[5,5]]
[[[0,[3,4]],[[3,4],[0,3]]],[[[9,6],[1,1]],[1,[8,7]]]]
[[[4,8],3],[3,[9,[8,9]]]]
[[5,[2,[5,2]]],[2,9]]
[[[[5,6],[1,8]],[3,6]],[3,[[4,4],[3,4]]]]
[[[1,0],3],[[1,[2,1]],[[2,5],[2,0]]]]
[[[6,7],[[0,5],9]],[[0,7],[[4,7],5]]]
[[[4,[3,1]],7],[[5,2],[3,0]]]
[[[6,6],[9,[2,6]]],[9,[[3,8],[2,6]]]]
[[[9,2],0],[[3,[6,6]],[7,[1,7]]]]
[[8,0],[9,[[5,5],5]]]
[[2,7],[[[8,7],0],[[1,1],[6,9]]]]
[[4,[7,[9,3]]],7]
[[[5,3],[[3,2],0]],[7,3]]
[[0,[8,[8,6]]],1]
[[4,5],[[[4,6],9],[3,0]]]
[[[[1,5],9],[[0,4],9]],[[[8,0],[4,2]],[0,[8,6]]]]
[[[6,4],[5,3]],3]
[[[[4,0],[6,6]],9],[[[7,0],7],[[4,5],3]]]
[[[[3,5],9],[[7,4],[6,8]]],[1,7]]
[[[[2,7],2],[9,3]],[[[1,2],3],7]]
[[[[9,4],[7,3]],0],[[7,[5,9]],[[7,0],[0,7]]]]
[[[5,6],[[6,5],[5,3]]],[[4,[8,5]],1]]
[[[2,6],0],[[1,0],[[7,2],[1,0]]]]
[[9,3],8]
[[[5,9],[2,[8,5]]],[[5,[4,7]],[[1,8],9]]]
[[[6,[6,4]],[0,1]],[0,[[3,9],9]]]
[3,9]
[[[7,5],[[9,3],[1,5]]],[[6,3],[8,[6,5]]]]
[[0,[0,5]],[7,0]]
[[[[0,9],7],3],[[8,6],[8,7]]]
[6,[7,[4,[9,0]]]]
[[[[2,4],[7,7]],4],[[1,5],5]]
[[3,6],[8,4]]
[[4,1],[[[3,9],[4,6]],[7,[3,0]]]]
[[[6,[9,1]],[7,4]],[[[5,7],[3,5]],[[2,2],5]]]
[[[[9,7],[8,2]],[0,[3,7]]],[[[8,8],4],[[5,2],5]]]
[[7,[0,[2,2]]],[4,[2,4]]]
[[[0,8],[[7,7],[8,0]]],[6,1]]
[6,[[[4,4],[3,9]],[[3,0],[4,3]]]]
[[[8,8],[2,[4,2]]],[[8,[0,1]],9]]
[4,[[6,[4,6]],[1,[6,9]]]]
[[[[8,1],[3,6]],[[5,3],7]],[[9,6],1]]
[[8,[[1,5],[1,7]]],[[[8,6],5],7]]
[6,3]
[[[[7,2],[9,9]],0],[[[9,0],8],[5,7]]]
[[[[1,0],3],[[7,0],[1,2]]],0]
[2,[[0,4],[6,[6,8]]]]
[[[[3,2],[4,1]],3],6]
[[[5,6],5],[[[3,4],[5,7]],[[5,5],6]]]
[1,[[8,[2,2]],[4,2]]]
[5,[[[4,7],1],[[6,6],7]]]
[[[[0,3],9],9],[0,[2,2]]]
[[[[8,9],3],5],[[1,6],[[6,5],[1,6]]]]
[[1,[[0,1],0]],[[[5,8],1],[1,[0,0]]]]
[[[[3,5],[9,4]],[7,[0,9]]],[8,[9,[1,9]]]]
[4,4]
[[7,[7,[0,2]]],[[8,8],[5,5]]]
[[[5,[2,8]],[3,3]],[4,[8,7]]]
[3,[8,[6,4]]]
[[8,[[7,7],2]],[[9,1],[[5,8],[8,1]]]]
[[[4,[5,2]],[[6,0],[7,7]]],[[[5,4],[8,3]],[[5,2],8]]]
[9,[2,5]]
[3,[5,5]]
[[[6,6],[3,[0,0]]],[[5,[3,3]],[8,8]]]
[[5,[2,[5,2]]],[[[8,7],9],[[4,1],6]]]
[[[[7,2],[8,5]],8],[[1,[5,5]],[0,7]]]
[[4,[6,8]],[[[2,4],[6,2]],[7,[3,6]]]]
[[8,5],[[[5,0],3],9]]
[[[[5,2],6],[7,2]],[[[7,4],9],0]]
[[[4,[6,5]],8],[[9,[1,5]],[8,9]]]
[[[5,[2,4]],[8,[9,4]]],[[1,5],2]]
[[[[1,4],2],[3,[8,9]]],7]
[[6,[1,7]],[9,2]]
[[[2,[9,0]],[[4,8],[3,4]]],[[[6,5],0],[[3,3],[4,3]]]]
[[[[4,4],[9,7]],[[4,8],7]],[[5,[6,6]],0]]
[[[[5,2],[2,2]],[[8,3],0]],[2,[3,5]]]
[[0,4],[[[9,0],[9,3]],[[1,1],6]]]
[5,[[[2,0],2],1]]
[[[[1,8],3],[[3,9],4]],[0,[[8,2],[7,4]]]]
[[[8,6],[[3,9],1]],0]
[[[[5,0],2],8],[4,[[3,5],[7,8]]]]
[[[7,[3,3]],[[2,5],[4,6]]],[[[0,9],[1,1]],[1,[4,9]]]]
[[[7,5],[[7,4],9]],[[[6,3],6],[2,6]]]
[[6,2],9]
[0,[[6,[2,0]],[[4,5],8]]]
[[9,[[6,2],[7,2]]],[[[6,5],6],[8,8]]]
[[[[2,0],[8,4]],[5,4]],[[3,2],[7,4]]]
[[[[0,1],[8,2]],3],[[6,[4,9]],[[0,2],1]]]
[2,[[8,[4,9]],[7,1]]]
[[[[6,4],4],[0,5]],[[6,0],3]]"""

    silver_tests = ["""[[[0,[5,8]],[[1,7],[9,6]]],[[4,[1,2]],[[1,4],2]]]
[[[5,[2,8]],4],[5,[[9,9],0]]]
[6,[[[6,2],[5,6]],[[7,6],[4,7]]]]
[[[6,[0,7]],[0,9]],[4,[9,[9,0]]]]
[[[7,[6,4]],[3,[1,3]]],[[[5,5],1],9]]
[[6,[[7,3],[3,2]]],[[[3,8],[5,7]],4]]
[[[[5,4],[7,7]],8],[[8,3],8]]
[[9,3],[[9,9],[6,[4,9]]]]
[[2,[[7,7],7]],[[5,8],[[9,3],[0,2]]]]
[[[[5,2],5],[8,[3,7]]],[[5,[7,5]],[4,4]]]"""]

    gold_tests = ["""""",""""""]

    answer = AocDay18(data,silver_tests,gold_tests,argv)

    print(answer)
