#!/usr/bin/env python3 
from itertools import product
from collections import defaultdict
from sys import argv
from aoc import AocDay
from math import inf
import turtle

class AocDay23(AocDay):

    VISUALIZE = False

    def scale(self,elf):
        SF = 3
        return (SF * elf[0], SF * elf[1])

    def plot(self,grid):
        turtle.screensize(600, 600)
        turtle.setworldcoordinates(-150, -150, 550, 550)
        turtle.register_shape('dot.gif')
        turtle.tracer(0)
        self.pen = turtle.Turtle()
        self.pen.penup()
        self.pen.shape("dot.gif")
        self.pen.speed("fastest")
        self.stamps = {}
        for elf in grid:           
            self.pen.setposition(self.scale(elf))
            self.stamps[elf] = self.pen.stamp()
        turtle.update()

    def replot(self,add,remove):
        self.pen.clearstamp(self.stamps[remove])
        self.pen.setposition(self.scale(add))
        self.stamps[add] = self.pen.stamp()

    def run(self,data,max_rounds):

        ELF = "#"
        data = data.splitlines()
        xdim, ydim = len(data[0]), len(data)

        grid = set()
        for y,x in product(range(ydim),range(xdim)):
            if data[y][x] == ELF: grid.add((x,y))

        if AocDay23.VISUALIZE: self.plot(grid)

        dirlist = [
            # Look vvv               Move vvv
            (((0,-1), (-1,-1), (1,-1)), (0,-1)),
            (((0,1),  (-1,1),  (1,1)),  (0,1)),
            (((-1,0), (-1,-1), (-1,1)), (-1,0)),
            (((1,0),  (1,1),   (1,-1)), (1,0))
        ]
        surrounding = lambda x,y: ((x-1,y),(x+1,y),(x,y-1),(x,y+1),(x-1,y-1),(x+1,y+1),(x-1,y+1),(x+1,y-1))
        has_adjacent = lambda me: any(elf in grid for elf in surrounding(*me))

        round = 1
        while round <= max_rounds:

            proposed = defaultdict(list)
            for x,y in filter(has_adjacent,grid):
                for look,move in dirlist:
                    if not any(p in grid for p in [(x+dx,y+dy) for dx,dy in look]):
                        dx,dy = move
                        proposed[(x+dx,y+dy)].append((x,y))
                        break

            moved = False
            for to,frs in proposed.items():
                if len(frs) == 1:
                    moved = True
                    grid.add(to)
                    grid.discard(fr := frs[0])
                    if AocDay23.VISUALIZE: self.replot(to,fr)

            if AocDay23.VISUALIZE: turtle.update()

            if not moved:
                if AocDay23.VISUALIZE: turtle.done()
                return round
            dirlist = dirlist[1:] + [dirlist[0]]
            round += 1

        xs = [x for (x,_) in grid]
        ys = [y for (_,y) in grid]

        if AocDay23.VISUALIZE: turtle.done()
        return (max(xs) - min(xs) + 1) * (max(ys) - min(ys) + 1) - len(grid)

    def run_silver(self,data):
        return self.run(data,10)

    def run_gold(self,data):
        return self.run(data,inf)

if __name__ == "__main__":

    silver_tests = [""".....
..##.
..#..
.....
..##.
.....""","""....#..
..###.#
#...#.#
.#...##
#.###..
##.#.##
.#..#.."""]

    gold_tests = ["""""",""""""]

    data = """.#.....####..##.#.#.####.####.##....#...###...##...#.#..###.##.....#.#
.##..##.#.#...####....#.###....##..######...#..#...#..####...#...#.###
#...#.###...#...###.##.....##.#.#....#..###..#.##..........#....###.##
##..#...###..####.#.#.###..###...##.#....##....###.#.##.##.#.###.###.#
##.#..#..###.#.#.####.#..#.#.####..###.#.#.#.##.#...#.#..#..#####..##.
...####..#.#.####.#.#.##.###.#.#.#.##...#..#.####..#.#.#.##.......###.
..###.#.###...##.######......#.##........#.##......#....#...##.#.##..#
#....###..##.#####..##.#######....##.#..##.##..#..##..##.###.......#.#
#.#....###.#..#...####...##.##.#....#.#.#.#...##..##........#.#.###.##
..#....##....####...##.#.##..###.##.#..##...##.##.##..##..#.#.###...##
##.##.#..###.#.##..#....###...####....#.#.#.####.##.##.#....##...#.###
##.####...#....#....#.#.#.#...#...#...####.###..#.#..##.##..##.#.#....
##...#####...#.#....##....##..#.........#.#..#######.#.##.#.....#.....
##....#..#....##.##..########.#...#....#..###...#....#.#.#..#.##.....#
..##..#....##..#.#..###...#..###.#.##..##....#..#.##...####.##.##...#.
#...##..##.###..##....#.##..##.#.......####.#.#.#.###..#.#...#..###.##
.##..##.#.##.#.#.#####.#.#.#...#..##..##.##.##..#.##...#####.##..##.##
.##..###.#..###.#...##.###......##..#.###..#########....##.##.#..##.#.
.##.#.##.#.#..#.....##.###.#..##......#.##...#....###.##..##.#....#..#
#..#..##...#.#....###..#..####.#..##.######.#..#.#....##.##.#.#.###..#
#......#.##..#..##.#.#..##..#...###.#.####..##..##.#..#.##.#..##..#..#
#..#.###....#..#.......#####.##.#..####.#.##...##..##.####.####.....##
#.#..#...###.##...####.###..#.######.##.##..#.###.#..#.#.#######......
.####.#..........####.#.#.#....#...#...#..#..#...#.###.#..##..###..#..
.###.#...####.#.#.#.#..###.#..####..##.####.###..#...#...##..#.#.###..
##....#.#....##..####..##.#.#.##...#.#.#...#.#.#.#....##.....###..##..
......#.#..###..##.#.#..#.##.####...####..####......#.##.#.#..##......
#...########.##.##..##.#..###.##.#.#..#...##.#.#..###.##.#..#..#.##.##
##..#.##.###.##...##.##....#.#.#..#...##.####..#.#####.####.###.#..#.#
##.#.#....###.#......#..##..####...###.......##.....#...#...###..####.
###..#####.#.#....##......##..#...#......#.##.####.#.####..###.#.#.###
#.#..#.###.#....#.##....###.###.#.##..##.#..####..###...#...#..####...
#....##.#.#...#..#...#########.###.#.....#..#..#..#.###...#.##...###.#
##...#....#.###.#####...##.##..#..#.##.##..###.#..#..######.#.#.##.##.
...#..##.#..####....##..#..###.#.######.###.#########..#..#.##...#..#.
###.##..#.#..###.#.......##.##.##.#####....#####.##.##.##..####..####.
.#####..#.#.#...##..#.#...#######.......###..#.####.#..##.######.#.#..
#.#..#######....##.#.#..#.#..###.#.#...##.#...#..#....#.####..#..#....
##..#.#...#..#######......#..#.#...#########.#.#..#...#.#####...###.#.
.######.##..#.#..##.........###..####.....##...#..#..#...##.##.######.
#####.#####.#..#.###..###..#...#.##.#.##.###.#.#.###.#####...#.##..#..
#...#.#...##......####.#..#.##..#..####....#.#.#...#.#.....##....#...#
####.###...##...#..#..###....#.##..#.#.##...###...#.#.#.....#.##..#.##
.#.###.#.##.#.##.#..#....#..#.####.#.#.......#..#..#..#.#.#..#..#..#.#
..#......#.#.###.#######.#...###########.##.##.##..##.##.....#.#..##..
##..#.#.#..###...#...#######..##.#.#.##.##..#.#..##.....###..#.##.###.
#...###....#.#....#####.####..#..#.#.#...###....#.#.#.##...####..#...#
##.####.#...####.##.##.#...#..#..##...#.##..#.#.#...#.#...#..#####.##.
###.#.#..#..###..##.#.#....#..#...##.#..##.#.##...##.#....##.#.#..##..
..#....##..####..#..######.##..####.#...##.#.##.###..#..##..##.##....#
##.###.##..#.....##.#.##....##.###.#.##..##.#...#...#.#..#..#.#.##....
.#..##.....###....#....###..###..#..#.#..#..####.#..###.#.##...##....#
#.#..#..#..#..####.####.....######....#...##.#..###.#...#.#.#.#.###...
##..#..##.#.#.##.......#.####.#.#.##.#.#.#..#.####.#.#.#####......#.#.
##.#.#...##....#..##..#......######.#..#.#.###.......##.#.##.#...#####
##..##########..#..#.....##...####.##.#.##..#.......######.#.##...#.#.
#.##.#.########.##..##.##..#.#.#...#.#..##..#...#..##.#.#####.#.#.###.
.###.#....###..######.##.########.########...##.#.#####.###.##..#.#...
....#.#.##.##..#####..#####.#.#.#...####.#.#..#....#.#.##...#..#.#.###
.#####......#.##.#######.#.#.#.##.#.#####..##..##.....###.##.###..#..#
#...#..#.#####.#.#...#..#..####.#..####..###.#...#.#.....####.##.#####
#..##......##...##.#..##.....#.##..#..##.##.#.#.#.......##.##..#.####.
#######..###.##.##.###.##..#.##..#...#.###....#.###...#...##...#..#..#
..######...##.#.#..#####.#.#######.###.....##.#.###.......##.#####..##
.#..#####.......#........#...#..###.######...####.#..##...###.##.....#
..##......#..#.####..##...#..###..##.....#..#...#..#.##.##....#.###...
#..####.##.#..###.##.##.#...##....#.##.#.###.##....####...#.....##.#..
..####...###.##.#..#....###...#.....######.####...##.##.#...#...####..
..#...#.#..###.#......##...##...#.....###.####.....##.#.#..###.#.#.###
..######..##...#..###.#....#..####.##..#...##.##..###.######.#..#.##.#"""

    answer = AocDay23(data,silver_tests,gold_tests,argv)

    print(answer)
