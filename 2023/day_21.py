#!/usr/bin/env python3 
from itertools import product
from collections import deque
from sys import argv
from aoc import AocDay

class AocDay21(AocDay):

    def parser(self,data):
        grid = data.splitlines()
        dim = len(grid)
        gardens = set()
        for x,y in product(range(dim),range(dim)):
            match grid[y][x]:
                case "." : gardens.add((x,y))
                case "S" :
                    gardens.add((x,y))
                    start = (x,y)

        return start, gardens, dim

    def run_silver(self,data):
        start, gardens, _ = self.parser(data)

        final = 0
        TARGET = 64
        parity = TARGET % 2

        visited = set()
        todo = deque([(0,start)])
        while todo:
            steps, pos = todo.popleft()
            if pos in visited:continue
            if steps > TARGET: break
            visited.add(pos)

            if steps % 2 == parity:
                final += 1
            
            x0,y0 = pos
            for dx,dy in self.deltas4:
                nxt = (x0 + dx, y0 + dy)
                if nxt in gardens:
                    todo.append((steps+1,nxt))

        return final
    
    def run_gold(self,data):
        start, gardens, dim = self.parser(data)

        TARGET = 26501365
        k, r = divmod(TARGET,dim)

        cur, new, result = {start}, {start}, {0:1}
        for steps in range(1, 2*dim + r + 1):
            prev,cur,new = cur,new,set()
            for (x0,y0),(dx,dy) in product(cur,self.deltas4):
                nxt = (x := x0+dx, y := y0+dy)
                if nxt not in prev and (x%dim,y%dim) in gardens:
                    new.add(nxt)

            result[steps] = (result[steps-2] if steps > 1 else 0) + len(new)

        # The mathsy bit
        # https://www.radfordmathematics.com/algebra/sequences-series/difference-method-sequences/quadratic-sequences.html
        terms = [result[r + dim*i] for i in range(3)]
        diffs = [terms[i+1] - terms[i] for i in range(2)]
        a = (diffs[1] - diffs[0]) // 2
        b = diffs[0] - 3*a
        c = terms[0] - (a + b)

        # k+1th term of the quadratic sequence an^2 + bn + c
        k += 1
        return a*k**2 + b*k + c
    
if __name__ == "__main__":

    silver_tests = ["""...........
.....###.#.
.###.##..#.
..#.#...#..
....#.#....
.##..S####.
.##..#...#.
.......##..
.##.#.####.
.##..##.##.
...........""",""""""]

    gold_tests = ["""""",""""""]

    data = """...................................................................................................................................
...##..##......#...###.....###...#..............#.......................#....................#.#.#........#.............#..........
.#..........#...#.#..#....#.#........#.....#..#...........#..................................#.....#.............#..#.#.#.....##...
..#....#...................#..........#....#..........#.#..........................#.............#.#.#..............#.#............
....#...#............#....#.#.#..#.........#..#......#..#....................#..#.#.............##............#.............##.....
..........#............##..#....#.#.............................#.................#....##.##.##....#...##..#.....#.....#.....#.....
......#..#...#.#..............#.#......#.#.......#....#........##..#.......#.#.#.....#......#..#.#..#.......#.........##...........
...#..#..............#....#.#.......#......#....#.....#.............#........................#.......#..#........#..........##.....
...#....#...#..#..#.....#..#....#.#...#.....#...................#.............#...#.....#..#..#..#.........#.....#.......#.........
....#....#.......##..........#............#..#.......................................#.#......#.#...#.....#...#........#...#.......
.....#...###....#....#...#..............#.........................#.##......................##..#..#.#.##.........#...#............
...........#.......#.......#.....#...............#................#.#..##...........##..#.......###.#.#..#...#.#..........#........
..#......###..........#.#.......#..#..#..##....#...................#....#........###..#.#.....#...........#..............#..#....#.
....#.........#.#....#.........#..#.#.....#...#.........#..#........#...................#....#.#....#..#.#.....#....#...##..#.##...
....#..#....#.............#.......#.#...#..............#..........#....#...#........##...#.......#.........#.##............##......
.......#.#...........#....#...................................#....#........#...........#.#.###...#.........#.##.#....#...#.#..##..
....#..#........#..#..#.#..#.........#......#.............#..............#..................#.....#.#.....#..#.........#...#.......
........##...##..#......##...........#.................#.....###..#....#...#..........#.#..............#..#......................#.
.#............#.......##...........#.....................#.........#.........................##.....#..###.....#...#..###........#.
...........##...#............#......#.................#.....#..#...#...#.......#.........#..##.........#....###.....#.#......##..#.
.#....##.......#.......#...#..##..#.#...#............#.#...#......#...........................#.........#........#.........##......
..#...#...##.#.......................##...........#..#........#.#.....##..#.##.#..#.......#..#.....#.####.#.......#......#.........
.....#.##.#...##.#...........#.................#.....#....#.#..#.......#.........................#.#......#.##..#....#.#........#..
.....##.###..#...................#.........................#..#....#..#....................................#..##..#.#...#..#..#.#..
.#......#.#......#.............#.##..#.........##...##..........#.........#..#...#.#...........#.....##.......#.............##.#...
....#..........#.#....#...#.#....................#.###.........#......##...#.........#............#........#....#..#....##.#...##..
.............##.....#...#...#......#.............#............##.....#.......#.#........................#..#..........#...#........
..#......##............#...#.........................##..##..............#..#......#.................##........#...............##..
..#.......#...#......#...................#........#..#...##............##..#.....#..........................#.#..........#.........
...##..#...##..........##....###.........#.......##..................#.......#....................#...........#.#........#.........
......#....#......#.......#...#....................#..#........#..#......#..#.#....##.........................#.#....#.#....#....#.
.....#......................#................#......##......##.#.........#..##.........#...............##.......#.........#........
.#.#......#.#....#..#...#..............#......#..#.#.....#..........##.....#..#........#...#.#.........#..#.....................#..
...#.##.#..#..#...#.#................###....................##.....#.#....#.........#......#..#..........##.#....#......#..#.......
...#.................#.............#................#.................###..............#.................#..#......#.....#......##.
.#.#.....#..#..........#...........#.#............#.##..#......#..##....#.#..###.......##.#.....#.........##...#.#...........#.....
..#...#................#....................#..#..........#...............#.....#..#..####................#...............#........
..........#..........#..............#........#...##...............#.....#...#...#..##.....#...#...........##.#.....##.#......#.....
....#......#.......#...#.......#........#....#.....#..............#....#..##..#......#........#...............#.................#..
.#.............#...............#...............#..#...#..#.#...#..#.......#....................#....#........#..##........#........
.....................................#....###....#...#.....##.#.......#.........#.#.....#........#...........#...........##......#.
.......#.##...#..............#..##..#...#...........#.##..##..#....#..#.........#........#.#.....................#.......#.......#.
..#......##...................#..........#........##.....#..........#...#.#....#.#....#............##..............#...#.#.#.......
...#.#.##.#.#.......................##......#.......#.........#.........#..........#........#.#.....#.#.............#.........#....
.#.#...........#..................#....#......#.#............#....#.#..#...#..#..##.#............................#.#........#.##...
..#...#....#...................#....#..........#.......................#.....##..#...#.#.#.......#...#..#.........#......##........
.......#.................#...#........#....#.................#......................#...#.........##..................#......#.....
..#..#....#..#...............#................#..#.#.....#.#..#.........###.......................#.#..#....#..........#...........
......#...#..#...........#......................#..#............................#.....#........#.....##...#............#...........
...........................##..#....#....#.....#....#....#...#........#.......#.........#.#..........##...#..................#..#..
......#.....................#.....#.......#.#.....#.............#....#...#......#....#..#..........#........#...........#..........
..#...#.............#..............#.#....#....#.....#....#...#.#......#.....#.#...........#.#.........#.#..................#..###.
..#..............#....##......#.##..................#...##.........#..........#.................#..........#...................#...
................#.##...#......##.........#.#...#..####.#.............#...#....#.........#.................................#........
....#..........................#.......#...............#......#.......#...###.##.....#.#.#....#..###....#...#...##...........##....
...#.#...............#..................#.........#...#.#..............#.....#.......#...#.##...#..#.......#.....#...........#.....
.....#.....................#.#.#.....#.#.....#..#..##...#.....#...........#...##........#..#.......#.#...#....#..#............#....
..#..........#....##..#.....###.#...............................#.#.##.#...#....##........#...#.....#....#............#.......#....
.#...........#...#..#.....#..........#............#.......##......#.................#.#...#..##........#...............#...........
.#................#........##.#.#.....#.#.............#.....#..#..##...............#..#................#.......#...#...##.......##.
.#........#.##........##..#.#.##.....#..###..#......##...#......#..........#...............#.....#....#......#.....................
............#.........#..............#.....#..#......................#...#.##.##...###..#..........###........###..................
...........#...##.............#......#.....#.#...#...#.#..#....#..#............#....#..#.....#.#.........#.....#..#.###....#.......
.........#........#.......#..#..##..#........#.#.#...........#....................##..#....#..#.....##.......##...##...............
.......#....##..........##.....#...##....#.........#..#...................#......###.....#........#.....................#.#.#......
.................................................................S.................................................................
.....#...........#...#....#...#..#.........#.......##.#.............................#...#....#......#......#...#.#......#....#.....
........###...#.......................#...........#.....#.#.........#.#......#...#.....#..#...###.....#.#....#..........#..........
...............#.#............#.#......#...#..#.......#..#.#..#....##.#..#....#...............#.##.#..#...#...#..#.................
.............#.##..........#........#.#........###.....#..............#.......#..........##...........#........#...#...............
...........#.#.#........#......###.....#.#......#.#..##..#..#...#...##.#.#...##.......#........#..#.#.##...###...........#.........
..........##..............#......#.............#..#.#....#..#.....#.#...#..........##............#...#.##.....#.#..#...............
.#.#...............#.#............##.......#...#..#....#.....#........#.#..###...#.....#.........#................#..#.............
.............#...#........#....#....#..........##.#....#......#.....#.........#..#........#.......###....#.#....#....##............
...#............#.#......#...#....#..............#.....#..##....#.....#....#.....#...#...#.#..#.........#.#.........#..............
..............#.......#...........#..............#.#.......#..#.#......#...##.......#................#...#.....#...#...............
...##...........................#...#...#.......#............#.#.....#...#....#..#......#..#.##....#.#...#...#.................#.#.
...#....#...........#.........##...#............#...............#...................................##..#......#..#..............#.
...##.#.#.............#....#.##.#........#.....#.#...#.....##...........#.....................#...#..#......#............##.....#..
...#..#...#...............#.#......#....#.#.#......#...................#......#.....##....#....#....##...#......#..............#...
......#..#.........#.................#...#................#.........#..................................................#....#......
.#..........#..........#..................#.#...#....#....#.#.........#..#...#........#......#.............#....................#..
........#............#........#.......##......##....#................#.......#....#.#.....#............#.#.#...............###.....
.##........#..........#...#......##..#.##.#.....##.........................#.....##.#...#......#.#......#..#..........#............
....#....................#...#.......#...#.......#.....#......#...#..#...#......#.#..#...##.##..#.....##...........#..#.###........
.#.....#........#..............#...#...#.........#.#................#.#.............##.#....#..#.....................#.....#..###..
......#...#.#..#.............##.#........#.....................#........#....#...........#....##......................#............
..#.....##...#..#.#.........#.#.......#.#..#......#..........#.##....#..#..................#.........#..#........#....##...........
..#...#.#....#.#...................##......##...........#...#.............#..........#.##..#.#......#..................#..#.#...##.
...##...#........#.#.........#...#.....#.#...##...#...#..#.#.........#.....#..#....#.###...#........#.............#.........#....#.
.........#...#.#...#.#.................#............#........................#.#.....#.........#................#.....#..#......#..
...........#.#..#.............##........#..........#....#...........#....#.....#....#....#.#......##.........#..##....#..##........
.........#..................................#..#...............#...#..#...#...#..#......#.#..#.............#...........#.#..#...##.
.#.#......#..#.......#.##........#......#....#................#...#...##..##....#.....#..........#.........#....#..#.#.........#...
.....#.....#.........#............#....#.....................#....#.##...#......................#................#.#.#...#.........
.....#.............##..#..........#..#..............##..#.................##........###.....#.#.........#.#.#...............#......
.#.#.#...#.#..............#...............#...............#..#.....#......#..............................#.......#.#...#.#...#.....
.................#........#...............#.........................................#......................#....#............#...#.
.#...#.###...........#...#..##...............#.........#...##....................#...........#...............#....##...........#.#.
..###...#.#.........##.................#.#.....#..##...........#....##........#...#...................##..##...#................#..
...#.................#.....#...........#....#...##...#.......#............#.....#.#........#........#...#...##...#.##..............
.......#....#.........#.#.....#.#.......#.....#....#...#.............#.....#.....#.##.....................#.###...........#........
................#....#..#.......#.............#......#.......#.................#.#................#..........#.....##...#..#....#..
........#...#...#.#......##......#.........#.......................#.........#...#.....................#..........#.#..#...#.......
....#.......##......##....##.................#.....#.#.#....#...#...........#.......................#........#....#....#.....#...#.
.#..##..##.........#......#.........#.......#....#....#...#.....#..#.....#.#............................#...#..................#.#.
...#......#............##.....##.............##.................#..#....#.#...#....#......................##....#.....#........#...
........#....#....#..........#.###....#................#..##......#..#...#..#......#..........##...............#..#.........#...#..
.....#...#.##.....#....#.##.........#............##....#..#.#.....#.............#...................#..#............#..#..#.#....#.
.....#..#.........##..#...........#....#............#.#...........#..............##.......#.#...........#..####.....##.#.##........
...#.#.#.##.#.#..#.....#........###..#............#........##......##.#..........................####........##.#.....#......#.....
.##.#.#...##..#........##....#........#............#...#...#......#....#....##..#...........#.#.........#.##...#...#...#...#.#.....
......#.#..#.#........##.#....#.#...#.###..#...........#...................#.................#.#.#............##.#...#.#.........#.
........#.#....#...#...#..........#.#..#..#...........#..#...#.....##......#.....................##..#........#.....#.#.....#....#.
..#.......##....##............##...............................#......#.#..#.............#..........................#....#.........
.......#....#................#...........#...##................#...#.#....#...............#....##.......................#.#.....#..
..........#...........#..#..#.....#...........##...........#......#.#.#.#..........#..........#.....#......................###.....
....#.......##...........#..........#..###.#.........................#....#..........#.#.........#......#............#..#.....#..#.
...#.#...#...#.............#.......#...#.##..............................#........##.......##..#...#......................#........
...........##.............#....##....#.#...#.#..............#..#..................#.......#......#.......#.................#..#....
.#.##..#......#...#..#........#.......#.#.#....#...............#........................#..........#...............................
........#...........#....#...#...##..#.#....###................#...#.................#..................#.......#....#........#..#.
.........#.###.#....#..#..##..........#.#.......#............................#..##....#.....#....#....#.#...##......##.............
..#.#..##.#........#..#.#...#........#...#...#.....................##...........#.....#...#.#.#...#.......#..#..#.........#..#..#..
.....#..........####....##..##......#.............#...#...........#........#..........#.............###...#.#.#...#................
..#.....#...#....#.#.........#....#..#.......##.....#.............#........#............#...###.........#...#......................
.##..............#..#....#..#......#....##..#......#.###.#..................#...............#.#..#..#.##..........#............#.#.
..#..#..#.....................#.#..............##...#.....#....................#..##...#.........#...........#..##.........#....#..
....#...............#.......#.#....##....#..#..........................#.......#.##...........#.......#....#.#........#..#.........
.....##.......#.................................#........#..................#..#.#......#....#..#....#...#.........................
..................................................................................................................................."""

    answer = AocDay21(data,silver_tests,gold_tests,argv)

    print(answer)
